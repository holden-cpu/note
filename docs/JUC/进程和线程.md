# 进程

## 定义

进程（Process）是计算机中的程序关于某数据集合上的一次运行活动，是系统进行<font color='red'>资源分配和调度的基本单位</font>，是操作系统操作系统结构的基础。在早期面向进程设计的计算机结构中，进程是程序的基本执行实体；在当代面向线程设计的计算机结构中，进程是线程的容器。程序是指令、数据及其组织形式的描述，进程是程序的实体

进程的概念主要有两点：第一，<font color='red'>进程是一个实体</font>。每一个进程都有它自己的地址空间，一般情况下，包括<font color='red'>文本区域</font>（text region）、<font color='red'>数据区域</font>（data region）和<font color='red'>堆栈</font>（stack region）。文本区域存储处理器执行的代码；数据区域存储变量和进程执行期间使用的动态分配的内存；堆栈区域存储着活动过程调用的指令和本地变量。第二，进程是一个“执行中的程序”。程序是一个没有生命的实体，只有处理器赋予程序生命时（操作系统执行之），它才能成为一个活动的实体，我们称其为[进程](https://baike.baidu.com/item/进程)

一个计算机系统进程包括（或者说“拥有”）下列数据：有关<font color='red'>内存地址空间</font>或虚拟地址空间的信息，所打开<font color='red'>⽂件的列表</font>和所使⽤的<font color='red'> I/O 设备</font>信息

那个程序的可运行机器码的一个在存储器的映像。 分配到的存储器（通常包括虚拟内存的一个区域）。[存储器](https://baike.baidu.com/item/存储器)的内容包括可运行代码、特定于进程的数据（输入、输出）、调用堆栈、堆栈（用于保存运行时运数中途产生的数据）。 分配给该进程的资源的操作系统描述符，诸如文件描述符或文件句柄（Windows）、数据源和数据终端。 安全特性，诸如进程拥有者和进程的权限集（可以容许的操作）。 处理器状态（内文），诸如寄存器内容、物理存储器寻址等。<font color='red'>当进程正在运行时，状态通常储存在寄存器，其他情况在存储器。</font>

## 特征

动态性：进程的实质是程序在多道程序系统中的一次执行过程，进程是动态产生，动态消亡的。

并发性：任何进程都可以同其他进程一起并发执行

独立性：进程是一个能独立运行的基本单位，同时也是系统分配资源和调度的独立单位；

异步性：由于进程间的相互制约，使进程具有执行的间断性，即进程按各自独立的、不可预知的速度向前推进

结构特征：<font color='red'>进程由程序、数据和进程控制块三部分组成</font>。

多个不同的进程可以包含相同的程序：一个程序在不同的数据集里就构成不同的进程，能得到不同的结果；但是执行过程中，程序不能发生改变。

### 区别

**程序**

<font color='red'>程序是指令和数据的有序集合，</font>其本身没有任何运行的含义，是一个静态的概念。而进程是程序在[处理机](https://baike.baidu.com/item/处理机)上的一次执行过程，它是一个动态的概念。

程序可以作为一种软件资料长期存在，而进程是有一定生命期的。程序是永久的，进程是暂时的。

进程更能真实地描述并发，而程序不能；

进程是由进程控制块、程序段、数据段三部分组成;

进程具有创建其他进程的功能，而程序没有。

同一程序同时运行于若干个数据集合上，它将属于若干个不同的进程，也就是说同一程序可以对应多个进程。

在传统的操作系统中，程序并不能独立运行，作为资源分配和独立运行的基本单元都是进程。

**线程**

通常在一个进程中可以包含若干个线程，它们可以利用进程所拥有的资源，在引入线程的[操作系统](https://baike.baidu.com/item/操作系统)中，通常都是把进程作为分配资源的基本单位，而把线程作为独立运行和独立调度的基本单位，由于线程比进程更小，基本上不拥有系统资源，故对它的调度所付出的开销就会小得多，能更高效的提高系统内多个程序间并发执行的程度。

当下推出的通用操作系统都引入了线程，以便进一步提高系统的并发性，并把它视为现代操作系统的一个重要指标。

# PCB 具体包含什么信息呢？

进程描述信息：

- 进程标识符：标识各个进程，每个进程都有⼀个并且唯⼀的标识符；
- ⽤户标识符：进程归属的⽤户，⽤户标识符主要为共享和保护服务；

进程控制和管理信息：

- 进程当前状态，如 new、ready、running、waiting 或 blocked 等；
- 进程优先级：进程抢占 CPU 时的优先级；

资源分配清单：

- 有关内存地址空间或虚拟地址空间的信息，所打开⽂件的列表和所使⽤的 I/O 设备信息。

**CPU** 相关信息：

- CPU 中各个寄存器的值，当进程被切换时，CPU 的状态信息都会被保存在相应的 PCB 中，以便进程重新执行时，能从断点处继续执行。

## CPU 上下⽂切换

各个进程之间是共享 CPU 资源的，在不同的时候进程之间需要切换，让不同的进程可以在 CPU 执⾏，那

么这个⼀个进程切换到另⼀个进程运⾏，称为进程的上下⽂切换。

在详细说进程上下⽂切换前，我们先来看看 CPU 上下⽂切换

⼤多数操作系统都是多任务，通常⽀持⼤于 CPU 数量的任务同时运⾏。实际上，这些任务并不是同时运⾏的，只是因为系统在很短的时间内，让各个任务分别在 CPU 运⾏，于是就造成同时运⾏的错觉。

任务是交给 CPU 运⾏的，那么在每个任务运⾏前，CPU 需要知道任务从哪⾥加载，⼜从哪⾥开始运⾏。

所以，操作系统需要事先帮 CPU 设置好 **CPU** 寄存器和程序计数器。

CPU 寄存器是 CPU 内部⼀个容量⼩，但是速度极快的内存（缓存）。我举个例⼦，寄存器像是你的⼝

袋，内存像你的书包，硬盘则是你家⾥的柜⼦，如果你的东⻄存放到⼝袋，那肯定是⽐你从书包或家⾥柜

⼦取出来要快的多。

再来，程序计数器则是⽤来存储 CPU 正在执⾏的指令位置、或者即将执⾏的下⼀条指令位置。

所以说，<font color='red'>CPU 寄存器和程序计数器</font>是 CPU 在运⾏任何任务前，所必须依赖的环境，这些环境就叫做 **CPU**

上下⽂。

既然知道了什么是 CPU 上下⽂，那理解 CPU 上下⽂切换就不难了。

CPU 上下⽂切换就是先把前⼀个任务的 CPU 上下⽂（CPU 寄存器和程序计数器）保存起来，然后加载新

任务的上下⽂到这些寄存器和程序计数器，最后再跳转到程序计数器所指的新位置，运⾏新任务。

系统内核会存储保持下来的上下⽂信息，当此任务再次被分配给 CPU 运⾏时，CPU 会重新加载这些上下

⽂，这样就能保证任务原来的状态不受影响，让任务看起来还是连续运⾏。

上⾯说到所谓的「任务」，主要包含进程、线程和中断。所以，可以根据任务的不同，把 CPU 上下⽂切换

分成：进程上下⽂切换、线程上下⽂切换和中断上下⽂切换。

## 进程的上下⽂切换

进程是由内核管理和调度的，所以进程的切换只能发⽣在内核态。

所以，进程的上下⽂切换不仅包含了<font color='red'>虚拟内存、栈、全局变量等⽤户空间的资源</font>，还包括了<font color='red'>内核堆栈、寄存器</font>等内核空间的资源。

通常，会把交换的信息保存在进程的 PCB，当要运⾏另外⼀个进程的时候，我们需要从这个进程的 PCB

取出上下⽂，然后恢复到 CPU 中，这使得这个进程可以继续执⾏，如下图所示：

![image-20220305143712974](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20220305143712974.png)

⼤家需要注意，进程的上下⽂开销是很关键的，我们希望它的开销越⼩越好，这样可以使得进程可以把更

多时间花费在执⾏程序上，⽽不是耗费在上下⽂切换。

### 发⽣进程上下⽂切换有哪些场景？

- 为了保证所有进程可以得到公平调度，CPU 时间被划分为⼀段段的时间⽚，这些时间⽚再被轮流分配给各个进程。这样，当某个进程的时间⽚耗尽了，进程就从运⾏状态变为就绪状态，系统从就绪队列选择另外⼀个进程运⾏；
- 进程在系统资源不⾜（⽐如内存不⾜）时，要等到资源满⾜后才可以运⾏，这个时候进程也会被挂起，并由系统调度其他进程运⾏；
- 当进程通过睡眠函数 sleep 这样的⽅法将⾃⼰主动挂起时，⾃然也会重新调度；
- 当有优先级更⾼的进程运⾏时，为了保证⾼优先级进程的运⾏，当前进程会被挂起，由⾼优先级进程来运⾏；
- 发⽣硬件中断时，CPU 上的进程会被中断挂起，转⽽执⾏内核中的中断服务程序；

以上，就是发⽣进程上下⽂切换的常⻅场景了。

# 线程

在早期的操作系统中都是以进程作为独⽴运⾏的基本单位，直到后⾯，计算机科学家们⼜提出了更⼩的能独⽴运⾏的基本单位，也就是线程。

多进程的存在的问题：

1. 进程之间如何通信，共享数据？

1. 维护进程的系统开销较⼤，如创建进程时，分配资源、建⽴ PCB；终⽌进程时，回收资源、撤销PCB；进程切换时，保存当前进程的状态信息；

那到底如何解决呢？需要有⼀种新的实体，满⾜以下特性：

- 实体之间可以并发运⾏；

- 实体之间共享相同的地址空间；

这个新的实体，就是线程**(** **Thread** **)**，线程之间可以并发运⾏且共享相同的地址空间。

## 什么是线程？

<font color='red'>线程是进程当中的⼀条执⾏流程。</font>

同⼀个进程内多个线程之间可以共享<font color='red'>代码段、数据段、打开的⽂件</font>等资源，但每个线程各⾃都有⼀套独⽴的<font color='red'>寄存器</font>和<font color='red'>栈</font>，这样可以确保线程的控制流是相对独⽴的

## 线程的优点：

⼀个进程中可以同时存在多个线程；

各个线程之间可以并发执⾏；

各个线程之间可以共享地址空间和⽂件等资源；

## 线程的缺点：

当进程中的⼀个线程崩溃时，会导致其所属进程的所有线程崩溃。

## 线程与进程的⽐较

- 进程是资源（包括内存、打开的⽂件等）分配的单位，线程是 CPU 调度的单位；

- 进程拥有⼀个完整的资源平台，⽽线程只独享必不可少的资源，如寄存器和栈；

- 线程同样具有就绪、阻塞、执⾏三种基本状态，同样具有状态之间的转换关系；

- 线程能减少并发执⾏的时间和空间开销；

对于，线程相⽐进程能减少开销，体现在：

1. 线程的创建时间⽐进程快，因为进程在创建的过程中，还需要资源管理信息，⽐如内存管理信息、⽂件管理信息，⽽线程在创建的过程中，不会涉及这些资源管理信息，⽽是共享它们；
2. 线程的终⽌时间⽐进程快，因为线程释放的资源相⽐进程少很多；
3. 同⼀个进程内的线程切换⽐进程切换快，因为线程具有相同的地址空间（虚拟内存共享），这意味着同⼀个进程的线程都具有同⼀个⻚表，那么在切换的时候不需要切换⻚表。⽽对于进程之间的切换，切换的时候要把⻚表给切换掉，⽽⻚表的切换过程开销是⽐较⼤的；
4. 由于同⼀进程的各线程间共享内存和⽂件资源，那么在线程之间数据传递的时候，就不需要经过内核了，这就使得线程之间的数据交互效率更⾼了；

所以，不管是时间效率，还是空间效率线程⽐进程都要⾼。

线程的上下⽂切换

在前⾯我们知道了，线程与进程最⼤的区别在于：线程是调度的基本单位，⽽进程则是资源拥有的基本单

位。

所以，所谓操作系统的任务调度，实际上的调度对象是线程，⽽进程只是给线程提供了虚拟内存、全局变

量等资源。

对于线程和进程，我们可以这么理解：

当进程只有⼀个线程时，可以认为进程就等于线程；

当进程拥有多个线程时，这些线程会共享相同的虚拟内存和全局变量等资源，这些资源在上下⽂切换

时是不需要修改的；

另外，线程也有⾃⼰的私有数据，⽐如栈和寄存器等，这些在上下⽂切换时也是需要保存的。线程上下⽂切换的是什么？

这还得看线程是不是属于同⼀个进程：

当两个线程不是属于同⼀个进程，则切换的过程就跟进程上下⽂切换⼀样；

当两个线程是属于同⼀个进程，因为虚拟内存是共享的，所以在切换时，虚拟内存这些资源就保持不

动，只需要切换线程的私有数据、寄存器等不共享的数据；

所以，线程的上下⽂切换相⽐进程，开销要⼩很多。

线程的实现

主要有三种线程的实现⽅式：

⽤户线程（**User Thread**）：在⽤户空间实现的线程，不是由内核管理的线程，是由⽤户态的线程库

来完成线程的管理；

内核线程（**Kernel Thread**）：在内核中实现的线程，是由内核管理的线程；

轻量级进程（**LightWeight Process**）：在内核中来⽀持⽤户线程；

那么，这还需要考虑⼀个问题，⽤户线程和内核线程的对应关系。

⾸先，第⼀种关系是多对⼀的关系，也就是多个⽤户线