## 网络层提供的两种服务

在计算机网络领域，网络层应该向运输层提供怎样的服务（“<font color='red'>面向连接</font>”还是“<font color='red'>无连接</font>”）曾引起了长期的争论。

争论焦点的实质就是：<font color='red'>在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？</font>

**一种观点：让网络负责可靠交付**。这种观点认为，应借助于电信网的成功经验，让网络负责可靠交付，计算机网络应模仿电信网络，使用<font color='red'>面向连接</font>的通信方式。通信之前先建立<font color='red'>虚电路</font> (Virtual Circuit)，以保证双方通信所需的一切网络资源。 如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。

![image-20210621000646556](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621000646556.png)

虚电路表示这只是一条<font color='red'>逻辑上的连接</font>，分组都沿着这条逻辑连接<font color='red'>按照存储转发方式传送</font>，而并不是真正建立了一条物理连接。请注意，电路交换的电话通信是先建立了一条真正的连接。因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。

**另一种观点：网络提供数据报服务**。互联网的先驱者提出了一种崭新的网络设计思路。网络层向上只提供简单灵活的、<font color='red'>无连接的、尽最大努力交付</font>的数据报服务。网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。<font color='red'>网络层不提供服务质量的承诺</font>。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。

**尽最大努力交付**：由于传输<font color='red'>网络不提供端到端的可靠传输服务</font>，这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）。如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的<font color='red'>主机中的运输层负责可靠交付</font>（包括差错处理、流量控制等）。<font color='red'>采用这种设计思路的好处是</font>：网络的造价大大降低，运行方式灵活，能够适应多种应用。互连网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。

![image-20210621001613300](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621001613300.png)

**虚电路服务与数据报服务的对比**：

| 对比的方面                     | 虚电路服务                                     | 数据报服务                                         |
| ------------------------------ | ---------------------------------------------- | -------------------------------------------------- |
| **思路**                       | 可靠通信应当由网络来保证                       | 可靠通信应当由用户主机来保证                       |
| **连接的建立**                 | 必须有                                         | 不需要                                             |
| **终点地址**                   | 仅在连接建立阶段使用，每个分组使用短的虚电路号 | 每个分组都有终点的完整地址                         |
| **分组的转发**                 | 属于同一条虚电路的分组均按照同一路由进行转发   | 每个分组独立选择路由进行转发                       |
| **当结点出故障时**             | 所有通过出故障的结点的虚电路均不能工作         | 出故障的结点可能会丢失分组，一些路由可能会发生变化 |
| **分组的顺序**                 | 总是按发送顺序到达终点                         | 到达终点时不一定按发送顺序                         |
| **端到端的差错处理和流量控制** | 可以由网络负责，也可以由用户主机负责           | 由用户主机负责                                     |

## **网际协议 IP**

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。

与 IP 协议配套使用的还有三个协议：

1. <font color='red'>地址解析协议 ARP</font> (Address Resolution Protocol)
2. <font color='red'>网际控制报文协议 ICMP</font> (Internet Control Message Protocol)
3. <font color='red'>网际组管理协议 IGMP</font> (Internet Group Management Protocol)

网际层的 IP 协议及配套协议：

![image-20210621002149598](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621002149598.png)

### **虚拟互连网络**

将网络互连并能够互相通信，会遇到许多问题需要解决，如：

1. 不同的寻址方案
2. 不同的最大分组长度
3. 不同的网络接入机制
4. 不同的超时控制
5. 不同的差错恢复方法
6. 不同的状态报告方法
7. 不同的路由选择技术
8. 不同的用户接入控制
9. 不同的服务（面向连接服务和无连接服务）
10. 不同的管理与控制方式等

如何将异构的网络互相连接起来？

使用一些中间设备进行互连：将网络互相连接起来要使用一些中间设备。 中间设备又称为中间系统或中继 (relay)系统。

有以下五种不同的中间设备：

- 物理层中继系统：<font color='red'>转发器</font> (repeater)。
- 数据链路层中继系统：<font color='red'>网桥</font> 或 桥接器 (bridge)。
- 网络层中继系统：<font color='red'>路由器</font> (router)。
- 网桥和路由器的混合物：<font color='red'>桥路器</font> (brouter)。
- 网络层以上的中继系统：<font color='red'>网关</font> (gateway)。

**网络互连使用路由器**：当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。 网关由于比较复杂，目前使用得较少。<font color='red'>网络互连都是指用路由器进行网络互连和路由选择</font>。由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为<font color='red'>网关</font>。   

互连网络与虚拟互连网络：

![image-20210621102304124](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621102304124.png)

虚拟互连网络的意义：<font color='red'>所谓虚拟互连网络也就是逻辑互连网络</font>，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们<font color='red'>利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络</font>。使用 IP 协议的虚拟互连网络可简称为 IP 网。使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。<font color='red'>如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的互联网 (Internet)。</font>

![](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621103102489.png)

从网络层看 IP 数据报的传送：

如果我们只从网络层考虑问题，那么 IP 数据报就可以想象是在网络层中传送。

![image-20210621103334525](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621103334525.png)

### **分类的 IP 地址**

在 TCP/IP 体系中，IP 地址是一个最基本的概念。

本部分重点学习：

- IP 地址及其表示方法

- 常用的三种类别的 IP 地址

#### 1.   IP 地址及其表示方法

我们把整个互联网看成为一个单一的、抽象的网络。

IP 地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是<font color='red'>唯一的 32 位的标识符</font>。

IP 地址现在由<font color='red'>互联网名字和数字分配机构ICANN</font> (Internet Corporation for Assigned Names and Numbers)进行分配。

**IP 地址的编址方法**：

<font color='red'>分类的 IP 地址</font>。这是最基本的编址方法，在1981年就通过了相应的标准协议。

<font color='red'>子网的划分</font>。这是对最基本的编址方法的改进，其标准[RFC 950]在1985年通过。

<font color='red'>构成超网</font>。这是比较新的无分类编址方法。1993年提出后很快就得到推广应用。

**分类 IP 地址**：

将IP地址划分为若干个固定类。

每一类地址都由两个固定长度的字段组成，其中一个字段是<font color='red'>网络号 net-id</font>，它标志主机（或路由器）所连接到的网络，而另一个字段则是<font color='red'>主机号 host-id</font>，它标志该主机（或路由器）。

主机号在它前面的网络号所指明的网络范围内必须是唯一的。

由此可见，<font color='red'>一个 IP 地址在整个互联网范围内是唯一的</font>。

**分类 IP 地址**：

这种两级的 IP 地址结构如下：

![image-20210621103859898](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621103859898.png)

这种两级的 IP 地址可以记为：

![image-20210621103916974](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621103916974.png)

各类 IP 地址的网络号字段和主机号字段：

![image-20210621104249974](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621104249974.png)

点分十进制记法：

![image-20210621104332089](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621104332089.png)

![image-20210621104510947](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621104510947.png)

#### 2. 常用的三种类别的 IP 地址

**IP 地址的指派范围**：

| 网络类别 | 最大可指派的网络数 | 第一个可指派的网络号 | 最后一个可指派的网络号 | 每个网络中最大主机数 |
| -------- | ------------------ | -------------------- | ---------------------- | -------------------- |
| **A**    | 126 (2^7 – 2)      | 1                    | 126                    | 16777214             |
| **B**    | 16383 (2^14 – 1)   | 128.1                | 191.255                | 65534                |
| **C**    | 2097151 (2^21 – 1) | 192.0.1              | 223.255.255            | 254                  |

**一般不使用的特殊的 IP 地址**：

| 网络号 | 主机号                 | 源地址使用 | 目的地址使用 | 代表的意思                                |
| ------ | ---------------------- | ---------- | ------------ | ----------------------------------------- |
| 0      | 0                      | 可以       | 不可         | 在本网络上的本主机（见 6.6 节 DHCP 协议） |
| 0      | host-id                | 可以       | 不可         | 在本网络上的某台主机 host-id              |
| 全 1   | 全 1                   | 不可       | 可以         | 只在本网络上进行广播（各路由器均不转发）  |
| net-id | 全 1                   | 不可       | 可以         | 对 net-id 上的所有主机进行广播            |
| 127    | 非全 0 或全 1 的任何数 | 可以       | 可以         | 用于本地软件环回测试                      |

**IP 地址的一些重要特点**：

1. <font color='red'>IP 地址是一种分等级的地址结构</font>。分两个等级的好处是：

   - 第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。

   - 第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。

2. <font color='red'>实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口</font>。

   - 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为<font color='red'>多归属主机</font> (multihomed host)。

   - 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此<font color='red'>一个路由器至少应当有两个不同的 IP 地址</font>。 

3.  用转发器或网桥连接起来的若干个局域网<font color='red'>仍为一个网络</font>，因此这些局域网<font color='red'>都具有同样的网络号 net-id</font>。

4. <font color='red'>所有分配到网络号 net-id 的网络</font>，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，<font color='red'>都是平等的</font>。

互联网中的 IP 地址：

![image-20210621105818745](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621105818745.png)

![image-20210621105901246](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621105901246.png)

![image-20210621110007898](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110007898.png)

### **IP 地址与硬件地址**

IP 地址与硬件地址是不同的地址。

从层次的角度看，

- <font color='red'>硬件地址</font>（或物理地址）是数据链路层和物理层使用的地址。
- <font color='red'>IP 地址</font>是网络层和以上各层使用的地址，是一种逻辑地址（称 IP 地址是逻辑地址是因为 IP 地址是用软件实现的）。

![image-20210621110116271](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110116271.png)

![image-20210621110314052](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110314052.png)

![image-20210621110337481](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110337481.png)

![image-20210621110409439](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110409439.png)

![image-20210621110420387](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110420387.png)

在 IP 层抽象的互联网上只能看到 IP 数据报。图中的  IP1 → IP2  表示从源地址 IP1 到目的地址 IP2 。<font color='red'>两个路由器的 IP 地址并不出现在 IP 数据报的首部中</font>。

路由器只根据目的站的 IP 地址的网络号进行路由选择。

在具体的物理网络的链路层，只能看见 MAC 帧而看不见 IP 数据报 。

IP 层抽象的互联网屏蔽了下层很复杂的细节。在抽象的网络层上讨论问题，就能够使用
统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信 。

![image-20210621110532285](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110532285.png)

主机 H1 与 H2 通信中使用的IP地址 与 硬件地址 HA：

![image-20210621110701110](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110701110.png)

### **地址解析协议 ARP**

通信时使用了两个地址：

- IP 地址（网络层地址）

- MAC 地址（数据链路层地址）

![image-20210621110802050](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621110802050.png)

**地址解析协议 ARP 的作用**：

已经知道了一个机器（主机或路由器）的IP地址，如何找出其相应的硬件地址？

地址解析协议 ARP 就是用来解决这样的问题的。

从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。

![image-20210621111316345](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621111316345.png)

**地址解析协议 ARP 要点**：

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。 

每一个主机都设有一个 <font color='red'>ARP 高速缓存</font> (ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

`< IP address；MAC address；TTL >`TTL (Time To Live)：地址映射有效时间 

当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。

1. 如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。
2. 如没有， ARP 进程在本局域网上广播发送一个 ARP 请求分组。收到 ARP 响应分组后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存。

<font color='red'>ARP请求分组</font>：包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址(未知时填 0) / 目标方 IP 地址。

<font color='red'>本地广播 ARP 请求</font>（路由器不转发ARP请求）。

<font color='red'>ARP 响应分组</font>：包含发送方硬件地址 / 发送方 IP地址 / 目标方硬件地址 / 目标方 IP 地址。

<font color='red'>ARP 分组封装在物理网络的帧中传输</font>。

![image-20210621111857198](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621111857198.png)

**ARP 高速缓存的作用**：

<font color='red'>存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。</font>

为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。

当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。

**应当注意的问题**：

ARP 用于解决<font color='red'>同一个局域网</font>上的主机或路由器的 IP 地址和硬件地址的映射问题。

如果所要找的主机和源主机不在同一个局域网上，那么就要<font color='red'>通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址</font>，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。

从 IP 地址到硬件地址的<font color='red'>解析是自动进行</font>的，主机的用户对这种地址解析过程是不知道的。

只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址。

**使用 ARP 的四种典型情况**：

![image-20210621112220388](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621112220388.png)

1. 发送方是主机，要把 IP 数据报发送到本网络上的另一个主机。这时用 ARP 找到目的主机的硬件地址。 
2. 发送方是主机，要把 IP 数据报发送到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 
3. 发送方是路由器，要把 IP 数据报转发到本网络上的一个主机。这时用 ARP 找到目的主机的硬件地址。 
4. 发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。 

**什么？不直接使用硬件地址进行通信？**

由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。

<font color='red'>IP 编址把这个复杂问题解决了</font>。连接到互联网的主机只需各自拥有一个唯一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用 ARP 的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。

因此，在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。

### **IP 数据报的格式**

一个 IP 数据报由<font color='red'>首部</font>和<font color='red'>数据</font>两部分组成。

首部的前一部分是<font color='red'>固定长度，共 20 字节</font>，是所有 IP 数据报必须具有的。

在首部的固定部分的后面是一些可选字段，其长度是可变的。

![image-20210621123025953](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621123025953.png)

**版本**——占 4 位，指 IP 协议的版本。目前的 IP 协议版本号为 4 (即 IPv4)。

**首部长度**——占 4 位，可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节。

**区分服务**——占 8 位，用来获得更好的服务。在旧标准中叫做服务类型，但实际上一直未被使用过。1998 年这个字段改名为区分服务。只有在使用区分服务（DiffServ）时，这个字段才起作用。在一般的情况下都不使用这个字段 

**总长度**——占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。<font color='red'>总长度必须不超过最大传送单元MTU</font>。

**标识**(identification) ——占 16 位，它是一个计数器，用来产生 IP 数据报的标识。 

**标志**(flag) ——占 3 位，目前只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF=1 表示后面“还有分片”。MF=0 表示最后一个分片。标志字段中间的一位是 DF (Don't Fragment) 。只有当 DF=0 时才允许分片

**片偏移**——占13 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。

IP 数据报分片：一数据报的总长度为 3820 字节，其数据部分的长度为 3800 字节（使用固定首部），需要分片为长度不超过 1420 字节的数据报片。因固定首部长度为 20 字节，因此每个数据报片的数据部分长度不能超过 1400 字节。于是分为 3 个数据报片，其数据部分的长度分别为 1400、1400 和 1000 字节。<font color='red'>原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值</font>。

![image-20210621123735462](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621123735462.png)

![image-20210621123802084](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621123802084.png)

**生存时间**——占8 位，记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值。

**协议**——占8 位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给那个处理过程

IP 协议支持多种协议，IP 数据报可以封装多种协议 PDU。

![image-20210621124558327](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621124558327.png)

**首部检验和**——占16 位，只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。

![image-20210621124732664](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621124732664.png)

**源地址**和**目的地址**都各占 4 字节

**IP 数据报首部的可变部分**：IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。选项字段的长度可变，从 <font color='red'>1 个字节</font>到 <font color='red'>40 个字节不等</font>，取决于所选择的项目。增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。实际上这些选项很少被使用。

### IP 层转发分组的流程

假设：有四个 A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。可以想象，若<font color='red'>按目的主机号来制作路由表</font>，每一个路由表就有 4 万个项目，即 4 万行（每一行对应于一台主机），则所得出的路由表就会过于庞大。但若<font color='red'>按主机所在的网络地址来制作路由表</font>，那么每一个路由器中的路由表就只包含 4 个项目（每一行对应于一个网络），这样就可使路由表大大简化。

![image-20210621125222413](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621125222413.png)

根据<font color='red'>目的网络地址就能确定下一跳路由器</font>，这样做的结果是：

- IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过<font color='red'>多次的间接交付</font>）。

- 只有到达最后一个路由器时，才试图向目的主机进行<font color='red'>直接交付</font>。

**特定主机路由**：虽然互联网所有的<font color='red'>分组转发</font>都是<font color='red'>基于目的主机所在的网络</font>，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。采用<font color='red'>特定主机路由</font>可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。

**默认路由** (default route)：路由器还可采用<font color='red'>默认路由</font>以<font color='red'>减少路由表所占用的空间和搜索路由表所用的时间</font>。这种转发方式在一个网络只有很少的对外连接时是很有用的。默认路由在主机发送 IP 数据报时往往更能显示出它的好处。如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的。

![image-20210621125625206](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210621125625206.png)

必须强调指出：

- IP 数据报的首部中<font color='red'>没有地方</font>可以用来指明“下一跳路由器的 IP 地址”。
- 当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是<font color='red'>送交下层的网络接口软件</font>。
- 网络接口软件<font color='red'>使用 ARP</font> 负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。

**路由器分组转发算法**：

1. 从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N。
2. 若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行 (3)。
3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行 (4)。
4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行 (5)。
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行 (6)。
6. 报告转发分组出错。 

关于路由表：

- 路由表没有给分组指明到某个网络的完整路径。
- 路由表指出，到某个网络应当先到某个路由器（即下一跳路由器）。
- 在到达下一跳路由器后，再继续查找其路由表，知道再下一步应当到哪一个路由器。
- 这样一步一步地查找下去，直到最后到达目的网络。

## **划分子网和构造超网**

### **划分子网**

### **使用子网时分组转发**

### **无分类编址 CIDR（构造超网）**

## **网际控制报文协议 ICMP**

### **ICMP 报文的种类**

### **ICMP 的应用举例**

## **因特网的路由选择协议**

### **有关路由选择协议的几个基本概念**

### **内部网关协议 RIP**

**(Routing Information Protocol)**

#### **工作原理**

- **路由信息协议 RIP 是内部网关协议 IGP中最先得到广泛使用的协议。**
- **RIP 是一种分布式的基于距离向量（DV，Distance Vector）的路由选择协议。**
- **RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。** 

**“距离”的定义**

- **从一路由器到直接连接的网络的距离定义为 1。**
- **从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。**
- **RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。**
- **这里的“距离”实际上指的是“最短距离”，** 

- **RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。**
- **RIP 允许一条路径最多只能包含 15 个路由器。**
- **“距离”的最大值为16 时即相当于不可达。可见 RIP 只适用于小型互联网。**
- **RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。**

**RIP 协议的三个要点**

- **仅和相邻路由器交换信息。** 
- **交换的信息是当前本路由器所知道的全部信息，即自己的路由表。** 
- **按固定的时间间隔交换路由信息，例如，每隔 30 秒。** 

**路由表的建立** 

- **路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为1）。**
- **以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。**
- **经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的<font color="red">最短距离</font>和下一跳路由器的地址。**
- **RIP 协议的收敛(convergence)过程较快，即在自治系统中所有的结点都得到正确的路由选择信息的过程。**

#### **距离向量算法**

**收到相邻路由器（其地址为 X）的一个 RIP 报文：**

1. **先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。**
2. **对修改后的 RIP 报文中的每一个项目，重复以下步骤：**
   **若项目中的目的网络不在路由表中，则把该项目加到路由表中。**
       **否则**
          **若下一跳字段给出的路由器地址是同样的，则把收到的项	目	替换原路由表中的项目。**
          **否则** 
              **若收到项目中的距离小于路由表中的距离，则进行更新，**
   	**否则，什么也不做。**
3. **若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为16（距离为16表示不可达）。**
4. **返回。**

**距离向量选路DV算法**

**![image-20210420110328808](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210420110328808.png)**

**是一种迭代的、异步的和分布式的算法。**

- **分布式：每个节点都从其直接相连邻居接收信息，进行计算，再将计算结果分发给邻居。**
- **迭代：计算过程一直持续到邻居之间无更多信息交换为止。**
  **自我终结：算法能自行停止。**
- **异步：不要求所有节点相互之间步伐一致地操作。**

**最低费用表示：**

**d~x~(y)：节点x到节点y的最低费用路径的费用。用Bellman-Ford方程表示**
            **d~x~(y) = min~v~{c(x,v)+ d~v~(y)}      （4-1）**

**c(x,v)+ d~v~(y)：x与某个邻居v之间的直接链路费用c(x，v)加上邻居v到y的最小费用。即<font color="red">x经v到节点y的最小的路径费用</font>。**

**min~v~ ：从所有经直接相连邻居到节点y的费用中选取的最小路径费用。**

**![image-20210420110853386](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210420110853386.png)**

**DV算法基本思想：**

- **D~x~(y)：节点x到N中某个节点y的估计费用；**
- **D~x~：节点x的距离向量。D~x~ = [D~x~(y)：y在N中]，即节点x到N中所有其他节点y的估计费用。**          

**基本思想：**
          **每个节点有一张选路表（距离表），维持选路数据，随着算法进行，不断更新，直到静止。**

- **节点x选路表**
- **更新选路表的距离向量**
- **当距离向量不再变化，算法静止**

**距离向量DV算法描述：**

**对每个节点x**
**（1）初始化：**
**（2）更新自己的距离向量** 
**（3）重复执行（2），直到没有更新的距离向量发出**

**<img src="https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210420112745546.png" alt="image-20210420112745546" style="zoom:50%;" />**

**（1）初始化:**

**计算节点x到所有目的点y的距离向量Dx(y)**
      ** 若目的点y是节点x的邻居，则Dx(y) = c(x,y )**
      ** 否则，Dx(y)= ∞            （2#～3#）**
**节点x的每一个邻居w到所有目的点y的距离向量为  
                 Dw(y) = ∞           （4#～5#）**
**把节点x的距离向量Dx = [Dx(y)：y在N中] （节点x到每个目的节点y的估计费用）发给每一个邻居w（6#～7#)**

**（2）更新距离向量** 

**发现直接相连的链路费用变化，或收到邻居的新距离向量，更新自己的距离向量 （10#～11#）**
  **用邻居的新距离向量更新到所有目的点y的距离向量        （13#～14#）**
                    **Dx(y) = minv{c(x,v)+ Dv(y)}**
        **在经每个邻居v到目的点y的距离向量中，选择一个最小值作为当前新距离向量，并将所经过的邻居v作为节点x转发表中到目的节点y的下一跳路由器v*(y)。**
  **若距离向量发生改变，向其邻居发送新距离向量。                    （16#～17#）**

#### **链路状态选路算法**

- **前提条件：已知网络拓扑和所有链路的费用，作为算法的输入。**
- **获取方法：每个节点向网络中广播链路状态分组（含有它所连接的链路的费用）。**
  - **由链路状态广播算法实现。最终使所有节点都有一个相同且完整的网络视图。**
- **每个节点都可以运行链路状态算法并计算出最低费用路径集。**

**Dijkstra最低费用路径算法（最短通路算法）**

- **计算从某节点（源节点，如u）到网络中所有其他节点的最低费用路径。**
- **是一种迭代算法，即：经第k次迭代后，可知道到k个目的节点的最低费用路径。**
- **基本思想：以源节点为起点，每次找出一个到源节点的费用最低的节点，直到把所有的目的节点都找到为止。**

**符号定义：**

- **c(x,y): 从节点x到y的链路费用;  
                  = ∞ 如果不是直接邻居**
- **D(v) ：从源节点到目的节点v的当前费用 ；**
- **p(v)： 从源节点到节点v的路径上的前一节点(节点v的邻居)；**
- **N'： 节点集合，从源节点到这些节点的最低费用路径已被求出。**

**<img src="https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210420113450359.png" alt="image-20210420113450359" style="zoom:50%;" />**



### **内部网关协议 OSPF**

### **外部网关协议 BGP**

## **路由器的构成**

## **IP 多播**

### **IP 多播的基本概念**

###    **在局域网上进行硬件多播**

### **因特网组管理协议 IGMP 和多播路由选择协议**

## **虚拟专用网 VPN 和网络地址转换 NAT**

###         **虚拟专用网 VPN**

### **网络地址转换 NAT**