## 网络层提供的两种服务

## 网际协议 IP

### 虚拟互连网络

### 分类的 IP 地址

### IP 地址与硬件地址

### 地址解析协议 ARP

### IP 数据报的格式

### IP 层转发分组的流程

## 划分子网和构造超网

### 划分子网

### 使用子网时分组转发

### 无分类编址 CIDR（构造超网）

## 网际控制报文协议 ICMP

### ICMP 报文的种类

### ICMP 的应用举例

## 因特网的路由选择协议

### 有关路由选择协议的几个基本概念

### 内部网关协议 RIP

(Routing Information Protocol)

#### **工作原理**

- 路由信息协议 RIP 是内部网关协议 IGP中最先得到广泛使用的协议。
- RIP 是一种分布式的基于距离向量（DV，Distance Vector）的路由选择协议。
- RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。 

“距离”的定义

- 从一路由器到直接连接的网络的距离定义为 1。
- 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。
- RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。
- 这里的“距离”实际上指的是“最短距离”， 

- RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。
- RIP 允许一条路径最多只能包含 15 个路由器。
- “距离”的最大值为16 时即相当于不可达。可见 RIP 只适用于小型互联网。
- RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。

RIP 协议的三个要点

- 仅和相邻路由器交换信息。 
- 交换的信息是当前本路由器所知道的全部信息，即自己的路由表。 
- 按固定的时间间隔交换路由信息，例如，每隔 30 秒。 

路由表的建立 

- 路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为1）。
- 以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。
- 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的<font color="red">最短距离</font>和下一跳路由器的地址。
- RIP 协议的收敛(convergence)过程较快，即在自治系统中所有的结点都得到正确的路由选择信息的过程。

#### 距离向量算法

收到相邻路由器（其地址为 X）的一个 RIP 报文：

1. 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。
2. 对修改后的 RIP 报文中的每一个项目，重复以下步骤：
   若项目中的目的网络不在路由表中，则把该项目加到路由表中。
       否则
          若下一跳字段给出的路由器地址是同样的，则把收到的项	目	替换原路由表中的项目。
          否则 
              若收到项目中的距离小于路由表中的距离，则进行更新，
   	否则，什么也不做。
3. 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为16（距离为16表示不可达）。
4. 返回。

**距离向量选路DV算法**

![image-20210420110328808](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210420110328808.png)

是一种迭代的、异步的和分布式的算法。

- 分布式：每个节点都从其直接相连邻居接收信息，进行计算，再将计算结果分发给邻居。
- 迭代：计算过程一直持续到邻居之间无更多信息交换为止。
  自我终结：算法能自行停止。
- 异步：不要求所有节点相互之间步伐一致地操作。

**最低费用表示：**

d~x~(y)：节点x到节点y的最低费用路径的费用。用Bellman-Ford方程表示
            d~x~(y) = min~v~{c(x,v)+ d~v~(y)}      （4-1）

c(x,v)+ d~v~(y)：x与某个邻居v之间的直接链路费用c(x，v)加上邻居v到y的最小费用。即<font color="red">x经v到节点y的最小的路径费用</font>。

min~v~ ：从所有经直接相连邻居到节点y的费用中选取的最小路径费用。

![image-20210420110853386](https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210420110853386.png)

**DV算法基本思想：**

- D~x~(y)：节点x到N中某个节点y的估计费用；
- D~x~：节点x的距离向量。D~x~ = [D~x~(y)：y在N中]，即节点x到N中所有其他节点y的估计费用。          

基本思想：
          每个节点有一张选路表（距离表），维持选路数据，随着算法进行，不断更新，直到静止。

- 节点x选路表
- 更新选路表的距离向量
- 当距离向量不再变化，算法静止

**距离向量DV算法描述：**

对每个节点x
（1）初始化：
（2）更新自己的距离向量 
（3）重复执行（2），直到没有更新的距离向量发出

<img src="https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210420112745546.png" alt="image-20210420112745546" style="zoom:50%;" />

（1）初始化:

计算节点x到所有目的点y的距离向量Dx(y)
       若目的点y是节点x的邻居，则Dx(y) = c(x,y )
       否则，Dx(y)= ∞            （2#～3#）
节点x的每一个邻居w到所有目的点y的距离向量为  
                 Dw(y) = ∞           （4#～5#）
把节点x的距离向量Dx = [Dx(y)：y在N中] （节点x到每个目的节点y的估计费用）发给每一个邻居w（6#～7#)

（2）更新距离向量 

发现直接相连的链路费用变化，或收到邻居的新距离向量，更新自己的距离向量 （10#～11#）
  用邻居的新距离向量更新到所有目的点y的距离向量        （13#～14#）
                    Dx(y) = minv{c(x,v)+ Dv(y)}
        在经每个邻居v到目的点y的距离向量中，选择一个最小值作为当前新距离向量，并将所经过的邻居v作为节点x转发表中到目的节点y的下一跳路由器v*(y)。
  若距离向量发生改变，向其邻居发送新距离向量。                    （16#～17#）

#### 链路状态选路算法

- 前提条件：已知网络拓扑和所有链路的费用，作为算法的输入。
- 获取方法：每个节点向网络中广播链路状态分组（含有它所连接的链路的费用）。
  - 由链路状态广播算法实现。最终使所有节点都有一个相同且完整的网络视图。
- 每个节点都可以运行链路状态算法并计算出最低费用路径集。

**Dijkstra最低费用路径算法（最短通路算法）**

- 计算从某节点（源节点，如u）到网络中所有其他节点的最低费用路径。
- 是一种迭代算法，即：经第k次迭代后，可知道到k个目的节点的最低费用路径。
- 基本思想：以源节点为起点，每次找出一个到源节点的费用最低的节点，直到把所有的目的节点都找到为止。

**符号定义：**

- c(x,y): 从节点x到y的链路费用;  
                  = ∞ 如果不是直接邻居
- D(v) ：从源节点到目的节点v的当前费用 ；
- p(v)： 从源节点到节点v的路径上的前一节点(节点v的邻居)；
- N'： 节点集合，从源节点到这些节点的最低费用路径已被求出。

<img src="https://note-java.oss-cn-beijing.aliyuncs.com/img/image-20210420113450359.png" alt="image-20210420113450359" style="zoom:50%;" />



### 内部网关协议 OSPF

### 外部网关协议 BGP

## 路由器的构成

## IP 多播

### IP 多播的基本概念

###    在局域网上进行硬件多播

### 因特网组管理协议 IGMP 和多播路由选择协议

## 虚拟专用网 VPN 和网络地址转换 NAT

###         虚拟专用网 VPN

### 网络地址转换 NAT